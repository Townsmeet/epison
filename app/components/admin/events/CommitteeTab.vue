<template>
  <div class="space-y-6">
    <!-- Add Committee Member -->
    <UCard>
      <template #header>
        <div class="flex items-center justify-between">
          <h3 class="text-base font-semibold">Committee Members</h3>
        </div>
      </template>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <UFormField label="Name" required>
          <UInput v-model="newMember.name" placeholder="Full name" />
        </UFormField>
        <UFormField label="Role">
          <UInput v-model="newMember.role" placeholder="Chair, Secretary, Logistics..." />
        </UFormField>
        <UFormField label="Email">
          <UInput v-model="newMember.email" type="email" placeholder="name@example.com" />
        </UFormField>
        <UFormField label="Phone">
          <UInput v-model="newMember.phone" placeholder="+234 ..." />
        </UFormField>
      </div>
      <div class="mt-4 flex justify-end">
        <UButton
          :disabled="!canAdd"
          :loading="isCreating"
          icon="i-heroicons-plus"
          @click="addMember"
          >Add Member</UButton
        >
      </div>
    </UCard>

    <!-- List -->
    <UCard>
      <template #header>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <h3 class="text-base font-semibold">Current Committee</h3>
            <UIcon
              v-if="isSyncing"
              name="i-heroicons-arrow-path"
              class="w-4 h-4 animate-spin text-gray-400"
            />
          </div>
          <span class="text-sm text-gray-500">{{ list.length }} total</span>
        </div>
      </template>

      <!-- Loading State -->
      <div v-if="committeeLoading" class="flex justify-center py-8">
        <UIcon name="i-heroicons-arrow-path" class="w-6 h-6 animate-spin" />
      </div>

      <div v-else-if="list.length === 0" class="p-6 text-sm text-gray-500">
        No committee members yet.
      </div>

      <div v-else class="divide-y divide-gray-200 dark:divide-gray-700">
        <div
          v-for="m in list"
          :key="m.id"
          class="flex flex-col md:flex-row md:items-center justify-between gap-3 p-4"
        >
          <div>
            <div class="font-medium text-gray-900 dark:text-white">{{ m.name }}</div>
            <div class="text-sm text-gray-500 dark:text-gray-300 break-words">
              <span v-if="m.role">{{ m.role }}</span>
              <span v-if="m.role && (m.email || m.phone)" class="mx-2">â€¢</span>
              <span v-if="m.email" class="break-all">{{ m.email }}</span>
              <span v-if="m.phone" class="ml-2 break-all">{{ m.phone }}</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <UButton
              color="neutral"
              variant="outline"
              icon="i-heroicons-pencil"
              @click="startEdit(m)"
            >
              Edit
            </UButton>
            <UButton
              color="error"
              variant="ghost"
              icon="i-heroicons-trash"
              @click="removeMember(m.id)"
            >
              Remove
            </UButton>
          </div>
        </div>
      </div>
    </UCard>

    <!-- Edit Modal -->
    <UModal v-model:open="isEditing">
      <template #content>
        <UCard>
          <template #header>
            <div class="flex items-center justify-between">
              <h3 class="text-base font-semibold">Edit Committee Member</h3>
              <UButton
                color="neutral"
                variant="ghost"
                icon="i-heroicons-x-mark"
                @click="isEditing = false"
              />
            </div>
          </template>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <UFormField label="Name" required>
              <UInput v-model="editMember.name" />
            </UFormField>
            <UFormField label="Role">
              <UInput v-model="editMember.role" />
            </UFormField>
            <UFormField label="Email">
              <UInput v-model="editMember.email" type="email" />
            </UFormField>
            <UFormField label="Phone">
              <UInput v-model="editMember.phone" />
            </UFormField>
          </div>

          <template #footer>
            <div class="flex justify-end gap-2">
              <UButton color="neutral" variant="ghost" @click="isEditing = false">Cancel</UButton>
              <UButton color="primary" @click="applyEdit">Save</UButton>
            </div>
          </template>
        </UCard>
      </template>
    </UModal>
  </div>
</template>

<script setup lang="ts">
import type { EventItem } from '~/composables/useEvents'
import type { EventCommitteeMember } from '../../../../types/event'

const props = defineProps<{ event: EventItem }>()

// Use the events API composable
const {
  getEventCommittee,
  createEventCommitteeMember,
  deleteEventCommitteeMember,
  refreshEventCommittee,
} = useEvents()

// Fetch committee data from API
const { data: committeeResponse, pending: committeeLoading } = await getEventCommittee(
  props.event.id
)
const list = computed(() => committeeResponse.value?.data || [])

const newMember = reactive({
  name: '',
  role: '',
  email: '',
  phone: '',
})

const canAdd = computed(() => newMember.name.trim().length > 0)

const isCreating = ref(false)
const isSyncing = ref(false)

async function addMember() {
  if (!canAdd.value || isCreating.value) return

  isCreating.value = true
  try {
    const memberData = {
      name: newMember.name.trim(),
      role: newMember.role?.trim() || undefined,
      email: newMember.email?.trim() || undefined,
      phone: newMember.phone?.trim() || undefined,
    }

    const created = await createEventCommitteeMember(props.event.id, memberData)
    // Optimistically update local list
    if (committeeResponse.value) {
      const current = Array.isArray(committeeResponse.value.data)
        ? committeeResponse.value.data
        : []
      committeeResponse.value.data = [created as unknown as EventCommitteeMember, ...current]
    }
    // Refresh from API for consistency
    isSyncing.value = true
    await refreshEventCommittee(props.event.id)
    // Additionally force Nuxt to refresh this key in case cookie-based trigger isn't immediate
    if (typeof refreshNuxtData === 'function') {
      await refreshNuxtData(`event-committee-${props.event.id}`)
    }
    isSyncing.value = false

    Object.assign(newMember, { name: '', role: '', email: '', phone: '' })
    useToast().add({ title: 'Member added', color: 'success' })
  } catch (error) {
    console.error('Error adding committee member:', error)
    useToast().add({ title: 'Error adding member', color: 'error' })
  } finally {
    isCreating.value = false
  }
}

async function removeMember(id: string) {
  try {
    await deleteEventCommitteeMember(props.event.id, id)
    // Optimistically remove from local list
    if (committeeResponse.value && Array.isArray(committeeResponse.value.data)) {
      committeeResponse.value.data = committeeResponse.value.data.filter(
        m => String(m.id) !== String(id)
      )
    }
    isSyncing.value = true
    await refreshEventCommittee(props.event.id)
    isSyncing.value = false
    useToast().add({ title: 'Member removed', color: 'success' })
  } catch (error) {
    console.error('Error removing committee member:', error)
    useToast().add({ title: 'Error removing member', color: 'error' })
  }
}

const isEditing = ref(false)
const editMember = reactive<{
  id?: string
  name: string
  role?: string
  email?: string
  phone?: string
}>({
  id: undefined,
  name: '',
  role: '',
  email: '',
  phone: '',
})

function startEdit(m: EventCommitteeMember) {
  Object.assign(editMember, m)
  isEditing.value = true
}

function applyEdit() {
  if (!editMember.id) return
  // Note: Update functionality would require an UPDATE endpoint
  // For now, we'll just close the modal
  useToast().add({
    title: 'Feature not available',
    description: 'Update committee member functionality will be available soon',
    color: 'warning',
  })
  isEditing.value = false
}
</script>
